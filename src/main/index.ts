import { app, globalShortcut } from "electron";
import {
  createWindow,
  addWindow,
  getWindows,
} from "./services/ui/windowManager";
import { setupOverlays } from "./services/ui/overlayManager";
import { startServers } from "./services/serverManager";
import { registerShortcuts } from "./services/ui/shortcutManager";
// This allows TypeScript to pick up the magic constants that's auto-generated by Forge's Webpack
// plugin that tells the Electron app where to look for the Webpack-bundled app code (depending on
// whether you're running in development or production).
declare const MAIN_WINDOW_WEBPACK_ENTRY: string;
declare const MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY: string;

app.on("ready", () => {
  const mainWindow = createWindow(
    MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY,
    MAIN_WINDOW_WEBPACK_ENTRY,
  );
  addWindow(mainWindow);

  setupOverlays(getWindows());
  registerShortcuts();
  startServers();
});

app.on("window-all-closed", () => {
  if (process.platform !== "darwin") {
    app.quit();
  }
});

app.on("activate", () => {
  if (getWindows().length === 0) {
    const mainWindow = createWindow(
      MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY,
      MAIN_WINDOW_WEBPACK_ENTRY,
    );
    addWindow(mainWindow);
  }
});

app.on("will-quit", () => {
  globalShortcut.unregisterAll();
});
